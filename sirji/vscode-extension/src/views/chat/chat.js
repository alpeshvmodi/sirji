const BotSvg = `
<svg xmlns="http://www.w3.org/2000/svg" version="1.0" width="24px" height="24px" viewBox="0 0 405.000000 598.000000" preserveAspectRatio="xMidYMid meet">
  <g transform="translate(0.000000,598.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
  <path d="M1885 5836 c-89 -28 -144 -74 -186 -156 -33 -62 -32 -174 0 -241 31 -66 82 -121 135 -150 l46 -24 0 -206 c0 -198 -1 -208 -22 -235 -31 -40 -229 -258 -238 -262 -4 -1 -48 40 -98 93 -64 66 -101 97 -122 101 -21 5 -30 12 -30 27 0 31 -36 82 -73 102 -25 13 -47 17 -82 13 -145 -17 -199 -197 -83 -280 27 -19 46 -23 107 -23 l75 -1 89 -96 89 -97 -83 -94 -83 -95 -117 112 c-95 92 -132 120 -197 152 -71 35 -81 43 -87 72 -9 46 -59 100 -106 112 -55 15 -115 -3 -155 -46 -105 -111 3 -296 149 -256 41 11 43 10 76 -24 18 -19 53 -44 77 -55 39 -19 214 -188 214 -207 0 -12 -125 -139 -245 -248 -128 -117 -243 -209 -337 -272 -37 -24 -69 -50 -72 -58 -9 -24 42 -140 67 -151 30 -14 54 -3 146 61 266 188 553 466 995 966 76 85 142 155 147 155 4 0 43 -43 86 -95 400 -492 775 -880 1093 -1131 122 -96 171 -129 192 -129 35 0 96 126 78 160 -6 11 -47 47 -91 81 -349 265 -829 764 -1183 1228 l-49 63 237 237 238 238 37 -10 c97 -26 201 49 201 145 0 44 -37 107 -79 135 -62 42 -155 25 -202 -36 -13 -18 -33 -41 -44 -51 -11 -10 -85 -82 -165 -159 -80 -78 -149 -141 -153 -141 -4 0 -7 47 -7 106 l0 105 35 15 c20 8 54 33 76 55 118 118 120 299 4 415 -82 83 -196 113 -300 80z m172 -220 c46 -50 45 -96 -1 -142 -28 -28 -42 -34 -76 -34 -111 0 -168 112 -92 182 36 34 49 38 97 33 30 -3 48 -13 72 -39z"/>
  <path d="M1352 5320 c-35 -22 -72 -88 -72 -130 0 -66 69 -150 123 -150 14 0 17 -5 12 -20 -15 -46 6 -102 57 -157 l50 -52 49 41 c27 23 61 56 75 75 l26 34 -40 43 c-56 61 -67 83 -53 113 17 37 13 114 -7 152 -37 68 -149 94 -220 51z"/>
  <path d="M780 5078 c-80 -41 -110 -143 -63 -219 59 -95 204 -93 263 3 46 76 14 183 -64 219 -54 24 -83 24 -136 -3z"/>
  <path d="M3002 5083 c-13 -3 -38 -20 -57 -39 l-35 -34 -139 1 c-156 1 -160 -1 -234 -70 -102 -95 -158 -188 -181 -297 -6 -29 0 -40 74 -128 44 -53 85 -96 89 -96 5 0 10 54 13 120 l5 119 42 54 c23 30 57 71 77 91 l35 36 117 0 c113 0 118 -1 161 -30 138 -94 301 59 218 204 -36 62 -98 86 -185 69z"/>
  <path d="M2775 4676 c-37 -16 -82 -68 -91 -102 -16 -63 16 -147 64 -169 21 -9 22 -16 23 -150 1 -77 1 -143 0 -147 -1 -9 132 -130 224 -203 98 -78 361 -254 392 -262 15 -3 33 -1 42 4 19 12 53 119 46 143 -3 9 -60 53 -128 97 -67 45 -180 130 -252 190 l-130 108 -5 115 c-4 99 -2 120 14 153 23 47 18 126 -11 165 -23 32 -97 72 -133 72 -14 -1 -39 -7 -55 -14z"/>
  <path d="M3221 4532 c-56 -28 -76 -64 -76 -138 0 -60 2 -66 37 -100 32 -32 44 -38 94 -42 99 -8 155 40 162 138 3 45 0 61 -20 90 -28 42 -80 70 -128 70 -19 0 -50 -8 -69 -18z"/>
  <path d="M1813 4153 c-305 -381 -766 -819 -1032 -980 -36 -22 -69 -46 -74 -55 -13 -20 -4 -54 32 -110 25 -39 36 -48 59 -48 53 0 239 128 462 319 134 116 414 398 518 523 40 48 76 89 81 92 8 5 131 -136 131 -150 0 -14 -265 -306 -361 -399 -182 -175 -498 -423 -650 -511 -42 -25 -79 -53 -82 -63 -11 -42 59 -151 97 -151 31 0 221 120 380 239 265 199 461 388 737 711 63 74 123 147 133 162 l17 26 -58 64 c-105 113 -219 244 -273 312 -30 36 -59 66 -66 66 -7 0 -30 -21 -51 -47z"/>
  <path d="M567 4146 c-127 -46 -146 -197 -36 -279 35 -25 118 -25 162 0 97 57 104 189 15 257 -42 31 -93 39 -141 22z"/>
  <path d="M2340 3530 l-63 -71 34 -36 c77 -82 309 -305 384 -370 157 -135 324 -253 358 -253 22 0 64 54 78 100 15 49 17 47 -131 165 -164 130 -275 229 -430 379 -75 72 -143 137 -152 144 -13 11 -24 2 -78 -58z"/>
  <path d="M2731 2633 c-90 -370 -355 -537 -571 -358 -65 54 -119 74 -160 58 -18 -7 -33 -7 -45 -1 -30 17 -80 -1 -152 -55 -82 -62 -141 -82 -218 -74 -107 11 -215 98 -285 228 -17 32 -33 59 -34 59 -2 0 -42 -18 -89 -40 -98 -46 -95 -35 -38 -147 110 -216 287 -381 502 -467 123 -49 186 -60 344 -59 168 0 253 20 392 88 239 118 404 315 517 617 20 53 36 101 36 106 0 8 -162 142 -172 142 -2 0 -15 -43 -27 -97z"/>
  <path d="M1020 1400 c-276 -7 -304 -12 -425 -72 -76 -39 -189 -152 -232 -234 -81 -153 -83 -350 -6 -499 33 -64 114 -166 161 -203 51 -40 138 -88 198 -109 45 -16 141 -18 1209 -21 1295 -3 1236 -6 1385 66 54 27 97 58 151 112 118 115 169 234 169 390 0 165 -49 281 -170 400 -83 82 -181 138 -275 158 -59 13 -1770 22 -2165 12z m632 -247 c22 -20 24 -66 2 -87 -18 -19 -65 -21 -82 -4 -17 17 -15 74 4 92 20 21 53 20 76 -1z m880 0 c20 -18 24 -73 6 -91 -17 -17 -73 -15 -89 4 -15 18 -14 71 3 91 15 18 58 16 80 -4z m237 -14 c30 -54 -19 -115 -72 -88 -28 15 -37 28 -37 58 0 61 80 83 109 30z m-1413 -144 c27 -8 59 -23 72 -33 l22 -17 -31 -37 -30 -38 -30 22 c-52 39 -139 25 -139 -23 0 -30 26 -46 103 -63 97 -22 132 -55 132 -126 0 -91 -63 -140 -180 -140 -71 0 -92 8 -155 59 l-25 20 31 31 31 32 38 -26 c45 -31 109 -35 137 -9 37 34 11 65 -70 82 -72 15 -109 36 -132 74 -41 67 -12 154 64 188 50 23 97 24 162 4z m293 -8 c15 -19 16 -414 0 -433 -17 -21 -66 -18 -79 5 -6 12 -10 99 -10 215 0 164 3 197 16 210 19 19 58 21 73 3z m441 -5 c54 -27 80 -74 80 -144 0 -67 -10 -92 -51 -128 l-29 -25 34 -54 c19 -30 32 -60 29 -67 -3 -8 -20 -16 -39 -20 -39 -7 -42 -4 -96 79 -30 47 -31 48 -77 45 l-46 -3 -3 -55 c-2 -30 -9 -58 -15 -62 -23 -15 -66 -8 -77 11 -13 25 -13 381 0 415 9 26 10 26 132 26 97 0 130 -4 158 -18z m441 8 c18 -10 19 -23 19 -168 0 -180 -13 -226 -72 -262 -70 -43 -134 -38 -194 15 l-39 34 32 32 31 32 27 -22 c29 -22 60 -27 83 -13 23 15 32 76 31 206 -1 114 1 131 17 143 22 16 39 16 65 3z m227 -2 c9 -9 12 -72 12 -220 l0 -208 -25 -12 c-19 -8 -31 -8 -50 0 l-25 12 0 198 c0 163 3 201 16 220 17 24 53 29 72 10z"/>
  <path d="M1897 903 c-4 -3 -7 -33 -7 -65 l0 -58 78 0 c88 0 102 8 102 57 0 53 -28 73 -103 73 -35 0 -67 -3 -70 -7z"/>
  </g>
</svg>
`;

const UserSvg = `
<svg fill="#000000" width="24px" height="24px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M6.03531778,18.739764 C7.62329979,20.146176 9.71193925,21 12,21 C14.2880608,21 16.3767002,20.146176 17.9646822,18.739764 C17.6719994,17.687349 15.5693823,17 12,17 C8.43061774,17 6.32800065,17.687349 6.03531778,18.739764 Z M4.60050358,17.1246475 C5.72595131,15.638064 8.37060189,15 12,15 C15.6293981,15 18.2740487,15.638064 19.3994964,17.1246475 C20.4086179,15.6703183 21,13.9042215 21,12 C21,7.02943725 16.9705627,3 12,3 C7.02943725,3 3,7.02943725 3,12 C3,13.9042215 3.59138213,15.6703183 4.60050358,17.1246475 Z M12,23 C5.92486775,23 1,18.0751322 1,12 C1,5.92486775 5.92486775,1 12,1 C18.0751322,1 23,5.92486775 23,12 C23,18.0751322 18.0751322,23 12,23 Z M8,10 C8,7.75575936 9.57909957,6 12,6 C14.4141948,6 16,7.92157821 16,10.2 C16,13.479614 14.2180861,15 12,15 C9.76086382,15 8,13.4273743 8,10 Z M10,10 C10,12.2692568 10.8182108,13 12,13 C13.1777063,13 14,12.2983927 14,10.2 C14,8.95041736 13.2156568,8 12,8 C10.7337387,8 10,8.81582479 10,10 Z"/>
</svg>
`;

const userInput = document.getElementById('userInput');
userInput.addEventListener('input', adjustTextAreaHeight);
userInput.addEventListener('paste', () => setTimeout(adjustTextAreaHeight, 0));
document.getElementById('sendBtn').addEventListener('click', sendUserMessage);

// Settings modal
document.getElementById('saveSettings').onclick = function () {
 saveSettings();
};
document.getElementById('openSettings').onclick = function () {
 openSettings();
};
document.getElementById('closeSettings').onclick = function () {
 closeSettings();
};

// IMP: Acquire the VS Code API
const vscode = acquireVsCodeApi();

// Listen for messages from the extension
window.addEventListener('message', (event) => {
 switch (event.data.type) {
  case 'settingSaved':
   settingSaved(event.data.content);
   break;

  case 'botMessage':
   sendBotMessage(event.data.content);
   break;

  default:
   sendBotMessage(`Unknown message received from facilitator: ${event.data}`);
 }
});

function sendUserMessage() {
 const message = userInput.value.trim();
 if (message) {
  displayMessage(message, 'user');
  vscode.postMessage({ type: 'userMessage', content: message });
  userInput.value = '';
  adjustTextAreaHeight();
 }
}

function updateIconColors() {
 const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

 const iconColor = isDarkMode ? '#FFFFFF' : '#000000'; // White for dark mode, black for light mode

 document.querySelectorAll('.icon').forEach((iconElement) => {
  iconElement.style.color = iconColor;
 });
}

function sendBotMessage(message) {
 message = message.trim();
 if (message) {
  displayMessage(message, 'bot');
  adjustTextAreaHeight();
 }
}

function adjustTextAreaHeight() {
 const minHeight = 15;
 const maxHeight = 90;

 userInput.style.height = minHeight + 'px';
 const newHeight = Math.min(maxHeight, Math.max(userInput.scrollHeight, minHeight));
 userInput.style.height = newHeight + 'px';
}

function displayMessage(msg, sender) {
 //  const messageContainer = document.getElementById('messageContainer');
 //  const messageDiv = document.createElement('div');

 const chatListContainerElement = document.getElementById('messageContainer');

 const messageElement = createMessageElement(msg, sender);

 // Defer the scrolling a bit to ensure layout updates
 chatListContainerElement.appendChild(messageElement);

 chatListContainerElement.scrollTop = chatListContainerElement.scrollHeight;

 userInput.value = '';
}

function createMessageElement(msg, sender) {
 const chatElement = document.createElement('div');

 // Construct user message HTML format
 if (sender === 'user') {
  chatElement.classList.add('user-message');
  const messageElement = document.createElement('div');
  messageElement.classList.add('user');
  messageElement.textContent = msg;

  chatElement.appendChild(messageElement);
  // Replace new line characters with HTML line break to properly display in HTML
  const formattedMessage = messageElement.innerHTML.replace(/\n/g, '<br>');
  messageElement.innerHTML = formattedMessage;

  const iconElement = document.createElement('div');
  iconElement.classList.add('icon');
  iconElement.innerHTML = UserSvg;
  chatElement.appendChild(iconElement);
 }

 // Construct bot message HTML format
 if (sender === 'bot') {
  chatElement.classList.add('bot-message');
  const iconElement = document.createElement('div');
  iconElement.classList.add('icon');
  iconElement.innerHTML = BotSvg;
  chatElement.appendChild(iconElement);

  const messageElement = document.createElement('div');
  messageElement.classList.add('bot');
  messageElement.textContent = msg;
  chatElement.appendChild(messageElement);
  const formattedMessage = messageElement.innerHTML.replace(/\n/g, '<br>');
  messageElement.innerHTML = formattedMessage;
 }

 return chatElement;
}

function openSettings() {
 document.getElementById('settingsModal').style.display = 'block';
 //  vscode.postMessage({ type: 'requestEnvVariables' });
}

function closeSettings() {
 document.getElementById('settingsModal').style.display = 'none';
}

function saveSettings() {
 const openAIKey = document.getElementById('SIRJI_OPENAI_API_KEY').value.trim();
 const googleSearchEngineId = document.getElementById('SIRJI_GOOGLE_SEARCH_ENGINE_ID').value.trim();
 const googleSearchEngineApiKey = document.getElementById('SIRJI_GOOGLE_SEARCH_ENGINE_API_KEY').value.trim();

 let isValid = true;

 document.getElementById('save_settings_error').textContent = '';

 if (!openAIKey) {
  document.getElementById('SIRJI_OPENAI_API_KEY_ERROR').textContent = 'OpenAI API Key is required.';
  isValid = false;
 } else {
  document.getElementById('SIRJI_OPENAI_API_KEY_ERROR').textContent = '';
 }

 if (!googleSearchEngineId) {
  document.getElementById('SIRJI_GOOGLE_SEARCH_ENGINE_ID_ERROR').textContent = 'Google Search Engine ID is required.';
  isValid = false;
 } else {
  document.getElementById('SIRJI_GOOGLE_SEARCH_ENGINE_ID_ERROR').textContent = '';
 }

 if (!googleSearchEngineApiKey) {
  document.getElementById('SIRJI_GOOGLE_SEARCH_ENGINE_API_KEY_ERROR').textContent =
   'Google Search Engine API Key is required.';
  isValid = false;
 } else {
  document.getElementById('SIRJI_GOOGLE_SEARCH_ENGINE_API_KEY_ERROR').textContent = '';
 }

 if (isValid) {
  const saveButton = document.getElementById('saveSettings');
  saveButton.textContent = 'Saving...';
  saveButton.disabled = true;

  const settings = {
   SIRJI_OPENAI_API_KEY: openAIKey,
   SIRJI_GOOGLE_SEARCH_ENGINE_ID: googleSearchEngineId,
   SIRJI_GOOGLE_SEARCH_ENGINE_API_KEY: googleSearchEngineApiKey
  };

  vscode.postMessage({ type: 'saveSettings', content: settings });
 }
}

function settingSaved(data) {
 const saveButton = document.getElementById('saveSettings');
 saveButton.textContent = 'Save';
 saveButton.disabled = false;
 if (data.success) {
  sendBotMessage(data.message);
  closeSettings();
 } else {
  document.getElementById(
   'save_settings_error'
  ).textContent = `Settings can not be saved. Please contact Sirji team. Error: ${data.message}`;
 }
}

updateIconColors();

vscode.postMessage({
 type: 'webViewReady',
 content: true
});
